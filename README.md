````markdown
# add_unclassified_one.sh

Добавляет в файл **Bracken TSV** итоговую строку **“Unclassified”**, которая учитывает:

1. не-классифицированные риды, уже отмеченные Kraken-ом как rank **U**;  
2. «потерянные» риды, которые не попали ни в одну из категорий Bracken (расхождение между числом прочтений в `*.kraken.report` и суммой всех таксонов в `*.bracken.tsv`).

В результате получается исправленный файл `*.bracken_withU.tsv`, пригодный для последующего импорта в R, Krona, Pavian и другие инструменты, требующие явного указания количества **Unclassified** ридов.

---


Скачайте файл `add_unclassified_one.sh` и положите его в директорию, которая уже находится в `$PATH`.

---

## Использование

```text
./add_unclassified_one.sh [-o <out.tsv>] <bracken.tsv> <kraken.report>
```

* **`-o <out.tsv>`** — имя выходного файла
  (по умолчанию `<sample>.bracken_withU.tsv`, где `<sample>` — префикс до расширения `.bracken.tsv`).

### Пример

```bash
./add_unclassified_one.sh \
    -o SRR34316421.fixed.tsv \
    SRR34316421.bracken.tsv \
    SRR34316421.kraken.report
```

> **Вывод в терминал**

```
✅ SRR34316421.fixed.tsv создан
   total              : 4 020 314
   unclassified+miss  : 568 140 (14.13%)
   miss               : 12 842
   unc                : 555 298
   cla                : 3 451 332
```

---

## Алгоритм

1. **Считает** общее число ридов

   ```bash
   total = root (rank R) + unclassified (rank U)
   ```
2. **Извлекает**:

   * `unc` — риды, помеченные Kraken-ом как **U**;
   * `cla` — сумму ридов в колонке 6 (`read_count`) файла Bracken.
3. **Вычисляет** «потерянные» риды

   ```bash
   miss = total - cla - unc
   ```
4. **Объединяет** `unc + miss` и добавляет строку

   ```
   Unclassified   0   S   0   0   <count>   <fraction>
   ```

   где `<fraction>` — доля от `total`, с точностью 6 знаков после запятой.
5. **Сохраняет** результат в выходной файл и печатает сводку.

Если `miss` получается отрицательным, скрипт выводит предупреждение и приравнивает его к нулю — проверьте соответствие входных файлов.

---

## Формат выходного файла

| № колонки | Название | Значение                     |
| --------- | -------- | ---------------------------- |
| 1         | Taxon    | `Unclassified`               |
| 2         | TaxID    | `0`                          |
| 3         | Rank     | `S` (специальная метка)      |
| 4, 5      | Parent   | `0` — фиктивные значения     |
| 6         | Reads    | Общее число неклассиф. ридов |
| 7         | Fraction | Доля всех прочтений (`0–1`)  |

Колонки 1–7 полностью повторяют порядок и формат оригинального `*.bracken.tsv`.

---

## Проверка

После выполнения скрипта суммы должны совпадать:

```bash
awk -F'\t' '{sum+=$6} END{print sum}' <sample>.bracken_withU.tsv
```

должна равняться

```bash
awk '$4=="R"{gsub(/,/,""); print $2}' <sample>.kraken.report
```


